# 写流程


![](/笔记/rocksdb/image/write.png)

1. MANIFEST 保存当前db的状态信息（类似于快照），主要是SST文件的各个版本信息（当sst文件被改动，即会生成对应的versionEdit，并触发sync写manifest文件），用于异常断电后恢复。
2. Memtable 常驻于内存中，在wal写之后写入key-value。
3. Immutable memtable ，当memtable被写满之后会生成一个新的memtable继续接受IO，旧的memtable就会变成 immutable memtable ，只读的状态，且开始flush到磁盘的L0。
4. SST文件，核心key-value的存储文件。

## 1. WAL


WAL文件由一堆变长的record组成，而每个record是由kBlockSize(32k)来分组，比如某一个record大于kBlockSize的话，他就会被切分为多个record（通过type来判断).

```
+---------+-----------+-----------+--- ... ---+
|CRC (4B) | Size (2B) | Type (1B) | Payload   |
+---------+-----------+-----------+--- ... ---+

CRC = 32bit hash computed over the payload using CRC
Size = Length of the payload data
Type = Type of record
       (kZeroType, kFullType, kFirstType, kLastType, kMiddleType )
       The type is used to group a bunch of records together to represent
       blocks that are larger than kBlockSize
Payload = Byte stream as long as specified by the payload size
```

## 1.1 创建wal
时机
- (1) 代码中调用打开一个新的DB
```c++
调用：
rocksdb::DB* db;
rocksdb::Options options;
options.create_if_missing = true;
rocksdb::Status status = rocksdb::DB::Open(options, "/tmp/testdb", &db);

底层：
Status DB::Open(const DBOptions& db_options, const std::string& dbname,
                const std::vector<ColumnFamilyDescriptor>& column_families,
                std::vector<ColumnFamilyHandle*>* handles, DB** dbptr) {
......................................................................
  s = impl->Recover(column_families);
  if (s.ok()) {
    uint64_t new_log_number = impl->versions_->NewFileNumber();
.............................................
    s = NewWritableFile(
        impl->immutable_db_options_.env,
        LogFileName(impl->immutable_db_options_.wal_dir, new_log_number),
        &lfile, opt_env_options);
................................................

```
- (2) 当一个CF(column family)被刷新到磁盘之后



rocksdb_ldb dump_wal --walfile=./000009.log  --header
Sequence,Count,ByteSize,Physical Offset,Key(s)
3,3,44,0,PUT(0) : 0x6B657931 PUT(0) : 0x6B657932 DELETE(0) : 0x6B657933 

rocksdb_ldb dump_wal --walfile=./000009.log  --header
Sequence,Count,ByteSize,Physical Offset,Key(s)
3,3,44,0,PUT(0) : 0x6B657931 PUT(0) : 0x6B657932 DELETE(0) : 0x6B657933 